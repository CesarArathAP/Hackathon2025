<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Resultado del Diagnóstico</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet"/>

  <style>
    :root {
      --brand: #1b5e20;
      --brand-light: #e2f6eb;
      --text-title: #ffffff;
    }

    body {
      background: #f4f8f5;
      font-family: "Segoe UI", sans-serif;
      overflow-x: hidden;
    }

    .custom-navbar {
      background:#ffffff;
      box-shadow:0 2px 10px rgba(0,0,0,0.12);
      padding:15px 60px;
    }
    .custom-navbar a {
      font-size:1rem;
      color:#4b4b4b !important;
    }
    .nav-logo {
      font-weight:600;
      color:#1b5e20 !important;
      font-size:1.4rem;
    }

    .card-diagnostico {
      max-width: 900px;
      margin: 90px auto;
      border-radius: 0 0 35px 35px;
      overflow: hidden;
      background: var(--brand-light);
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      border: none;
    }

    .card-header-custom {
      background: var(--brand);
      padding: 50px 60px;
    }

    .card-header-custom h1 {
      color: var(--text-title);
      font-weight: 700;
      font-size: 2.8rem;
    }

    .card-body-custom {
      padding: 40px 60px;
    }

    .result-item {
      margin-bottom: 18px;
      padding: 18px;
      background: #ffffff;
      border-radius: 10px;
      border-left: 6px solid var(--brand);
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }

    .result-item h5 {
      font-weight: 700;
      margin-bottom: 6px;
    }

    h3.text-success {
      font-weight: 700;
      margin-top: 20px;
      font-size: 1.6rem;
    }

    .alert-info {
      margin: 20px 0;
    }

    .btn-group-custom {
      display: flex;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .info-guardado {
      background: #d4edda;
      border: 1px solid #c3e6cb;
      border-radius: 8px;
      padding: 15px;
      margin: 20px 0;
    }

    .info-guardado p {
      margin: 5px 0;
    }
  </style>
</head>

<body>

  <div class="card card-diagnostico">
    <div class="card-header-custom">
      <h1>Diagnóstico</h1>
    </div>

    <div class="card-body-custom">
      <!-- Mensaje de estado -->
      <div id="alertContainer"></div>

      <!-- Información del diagnóstico guardado -->
      <div id="infoGuardado" style="display: none;"></div>

      <!-- Contenedor de resultados -->
      <div id="resultadoIA"></div>

      <!-- Botones de acción -->
      <div class="text-center mt-4 btn-group-custom">
        <button id="btnGuardar" class="btn btn-primary btn-lg">
          <i class="bi bi-file-earmark-pdf"></i> Generar y Guardar PDF
        </button>
        <button id="btnDescargar" class="btn btn-success btn-lg" style="display: none;">
          <i class="bi bi-download"></i> Descargar PDF
        </button>
      </div>
    </div>
  </div>

  <script>
    const resultadoIAContainer = document.getElementById('resultadoIA');
    const alertContainer = document.getElementById('alertContainer');
    const infoGuardadoContainer = document.getElementById('infoGuardado');
    const iaData = JSON.parse(localStorage.getItem('catastroIA')) || {};
    let diagnosticoInfo = null;

    // Mostrar mensajes de alerta
    function mostrarAlerta(mensaje, tipo = 'info') {
      alertContainer.innerHTML = `
        <div class="alert alert-${tipo} alert-dismissible fade show" role="alert">
          ${mensaje}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      `;
      
      // Auto-cerrar después de 5 segundos si es éxito
      if (tipo === 'success') {
        setTimeout(() => {
          const alert = alertContainer.querySelector('.alert');
          if (alert) {
            alert.classList.remove('show');
            setTimeout(() => alert.remove(), 150);
          }
        }, 5000);
      }
    }

    // Mostrar información del diagnóstico guardado
    function mostrarInfoGuardado(info) {
      infoGuardadoContainer.style.display = 'block';
      infoGuardadoContainer.innerHTML = `
        <div class="info-guardado">
          <h6><i class="bi bi-check-circle-fill text-success"></i> Diagnóstico Guardado</h6>
          <p><strong>ID:</strong> ${info.id_diagnostico}</p>
          <p><strong>Archivo:</strong> ${info.nombre_archivo}</p>
          <p><strong>Ubicación:</strong> /assets/diagnosticos/${info.nombre_archivo}</p>
        </div>
      `;
    }

    // Renderizar resultados del diagnóstico
    const camposIA = [
      { key: 'diagnostico_tecnico', label: 'Diagnóstico Técnico' },
      { key: 'nivel_madurez', label: 'Nivel de Madurez' },
      { key: 'recomendaciones_IUCA', label: 'Recomendaciones IUCA' },
      { key: 'resumen_ejecutivo', label: 'Resumen Ejecutivo' }
    ];

    camposIA.forEach(c => {
      if (iaData[c.key]) {
        const div = document.createElement('div');
        div.className = 'result-item';
        let valor = iaData[c.key];

        if (Array.isArray(valor)) {
          valor = valor.map(v => typeof v === 'object'
            ? Object.values(v).join(', ')
            : v).join('<br>• ');
          valor = '• ' + valor;
        }

        div.innerHTML = `<h5>${c.label}</h5><p>${valor}</p>`;
        resultadoIAContainer.appendChild(div);
      }
    });

    // Generar y guardar PDF en el servidor
    document.getElementById("btnGuardar").addEventListener("click", async () => {
      try {
        // Obtener el ID del usuario desde localStorage
        const usuarioData = localStorage.getItem('usuario');
        let idUsuario = null;
        
        if (usuarioData) {
          try {
            const usuario = JSON.parse(usuarioData);
            idUsuario = usuario.id || usuario.id_usuario;
          } catch (e) {
            console.error('Error al parsear usuario:', e);
          }
        }
        
        // Fallback: intentar desde sessionStorage
        if (!idUsuario) {
          idUsuario = sessionStorage.getItem('userId');
        }
        
        // Validar que tenemos un ID de usuario válido
        if (!idUsuario || idUsuario === 'null' || idUsuario === 'undefined') {
          mostrarAlerta('Error: No se pudo identificar el usuario. Por favor, inicia sesión.', 'danger');
          return;
        }
        
        // Asegurar que sea un número
        idUsuario = parseInt(idUsuario, 10);
        if (isNaN(idUsuario)) {
          mostrarAlerta('Error: ID de usuario inválido. Por favor, inicia sesión nuevamente.', 'danger');
          return;
        }
        
        console.log('ID Usuario obtenido:', idUsuario);

        const btnGuardar = document.getElementById("btnGuardar");
        btnGuardar.disabled = true;
        btnGuardar.innerHTML = '<i class="bi bi-hourglass-split"></i> Generando y guardando PDF...';

        // Enviar petición para generar y guardar el PDF
        const response = await fetch("/api/pdf/generate", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            diagnostico: iaData,
            id_usuario: idUsuario
          })
        });

        const result = await response.json();
        console.log('Respuesta de /api/pdf/generate:', result);

        if (response.ok && result.success) {
          diagnosticoInfo = result;
          
          // Guardar información en localStorage
          localStorage.setItem('ultimoDiagnosticoId', result.id_diagnostico);
          localStorage.setItem('ultimoDiagnosticoArchivo', result.nombre_archivo);

          // Mostrar información del archivo guardado
          mostrarInfoGuardado(result);
          mostrarAlerta(`✓ ${result.message}`, 'success');
          
          // Ocultar botón de guardar y mostrar botón de descargar
          btnGuardar.style.display = 'none';
          document.getElementById('btnDescargar').style.display = 'inline-block';
        } else {
          const errorMsg = result.error || 'Error al generar el PDF';
          console.error('Error en respuesta:', errorMsg);
          throw new Error(errorMsg);
        }
      } catch (error) {
        console.error('❌ Error completo:', error);
        console.error('   Stack:', error.stack);
        mostrarAlerta(`Error: ${error.message}`, 'danger');
        const btnGuardar = document.getElementById("btnGuardar");
        btnGuardar.disabled = false;
        btnGuardar.innerHTML = '<i class="bi bi-file-earmark-pdf"></i> Generar y Guardar PDF';
      }
    });

    // Descargar PDF guardado
    document.getElementById("btnDescargar").addEventListener("click", async () => {
      try {
        if (!diagnosticoInfo) {
          // Intentar recuperar de localStorage
          const id = localStorage.getItem('ultimoDiagnosticoId');
          if (id) {
            window.location.href = `/api/diagnosticos/${id}/pdf`;
            return;
          }
          throw new Error('No hay información del diagnóstico');
        }

        // Descargar usando el ID del diagnóstico
        window.location.href = `/api/diagnosticos/${diagnosticoInfo.id_diagnostico}/pdf`;
        
        mostrarAlerta('✓ Descarga iniciada', 'success');
      } catch (error) {
        console.error('Error:', error);
        mostrarAlerta(`Error al descargar: ${error.message}`, 'danger');
      }
    });

    // Verificar si hay datos para mostrar
    if (!iaData || Object.keys(iaData).length === 0) {
      resultadoIAContainer.innerHTML = `
        <div class="alert alert-warning">
          <i class="bi bi-exclamation-triangle"></i> 
          No hay datos de diagnóstico disponibles. Por favor, completa el formulario primero.
        </div>
      `;
      document.getElementById("btnGuardar").style.display = 'none';
    }

    // Verificar si ya se guardó automáticamente (tiene id_diagnostico)
    if (iaData && iaData.id_diagnostico) {
      console.log('✓ Diagnóstico ya guardado automáticamente con ID:', iaData.id_diagnostico);
      mostrarInfoGuardado({
        id_diagnostico: iaData.id_diagnostico,
        nombre_archivo: iaData.nombre_archivo || 'Pendiente de generar PDF'
      });
      document.getElementById('btnGuardar').style.display = 'inline-block';
      document.getElementById('btnGuardar').innerHTML = '<i class="bi bi-file-earmark-pdf"></i> Generar PDF';
      diagnosticoInfo = {
        id_diagnostico: iaData.id_diagnostico,
        nombre_archivo: iaData.nombre_archivo
      };
    }
    // Verificar si ya existe un diagnóstico guardado en localStorage
    else {
      const diagnosticoGuardadoId = localStorage.getItem('ultimoDiagnosticoId');
      const diagnosticoGuardadoArchivo = localStorage.getItem('ultimoDiagnosticoArchivo');
      if (diagnosticoGuardadoId && diagnosticoGuardadoArchivo) {
        mostrarInfoGuardado({
          id_diagnostico: diagnosticoGuardadoId,
          nombre_archivo: diagnosticoGuardadoArchivo
        });
        document.getElementById('btnGuardar').style.display = 'none';
        document.getElementById('btnDescargar').style.display = 'inline-block';
        diagnosticoInfo = {
          id_diagnostico: diagnosticoGuardadoId,
          nombre_archivo: diagnosticoGuardadoArchivo
        };
      }
    }
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>